<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
{% if session.get('user_id') %}
<div class="container">
  <div class="sidebar">
    <form action="{{ url_for('logout') }}" method="GET">
      <button type="submit">Logout</button>
    </form>
    <h2>Users</h2>
    <ul id="users" class="user-list">
      {% for user in users %}
      <li class="user-item" data-id="{{ user[0] }}">
        <strong>{{ user[1] }}</strong><br>
        <small>{{ user[2] }}</small>
        <button class="call-user-btn">📞</button>
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="chat">
    <div class="chat-header">
      <h3 id="chat-with">Select a user</h3>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Enter a message">
      <button onclick="sendMessage()">➤</button>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];

  let currentChatUserId = null;
  let localStream = null;
  let peerConnection = null;

  socket.on('connect', () => {
    console.log('Socket connected:', socket.id);
    socket.emit('register', { user_id: {{ session["user_id"] }} });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const chatWithEl = document.getElementById('chat-with');
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('messageInput');

    document.querySelectorAll('.user-item').forEach(item => {
      item.addEventListener('click', e => {
        if (e.target.classList.contains('call-user-btn')) return;
        currentChatUserId = item.dataset.id;
        chatWithEl.textContent = `Chat with ${item.querySelector('strong').textContent}`;
        loadMessages(currentChatUserId);
      });
    });

    function loadMessages(userId) {
      fetch(`/messages/${userId}`)
        .then(res => res.json())
        .then(msgs => {
          chatBox.innerHTML = '';
          msgs.forEach(m => {
            const div = document.createElement('div');
            div.className = m.from_me ? 'message me' : 'message you';
            div.textContent = m.from_me ? `You: ${m.message}` : m.message;
            chatBox.appendChild(div);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    window.sendMessage = () => {
      if (!currentChatUserId) return alert('Выберите пользователя');
      const text = messageInput.value.trim();
      if (!text) return;
      fetch('/send', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ to_user_id: currentChatUserId, message: text })
      }).then(() => {
        messageInput.value = '';
        loadMessages(currentChatUserId);
      });
    };

    socket.on('new_message', data => {
      if (+data.from_user_id === +currentChatUserId || +data.to_user_id === +currentChatUserId) {
        loadMessages(currentChatUserId);
      }
    });

    document.querySelectorAll('.call-user-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const targetId = btn.closest('.user-item').dataset.id;
        if (targetId) startCall(targetId);
      });
    });

    // SIGNAL EVENTS
    socket.on('call-made', async data => {
      await handleIncomingCall(data.from, data.offer);
    });

    socket.on('answer-made', async data => {
      if (peerConnection) {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
    });

    socket.on('ice-candidate', async data => {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      } catch (err) {
        console.error('Failed to add ICE candidate:', err);
      }
    });
  });

  async function startCall(targetId) {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    attachLocalStream(localStream);

    peerConnection = new RTCPeerConnection({ iceServers: ICE_SERVERS });
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        socket.emit('ice-candidate', { to: targetId, candidate: e.candidate });
      }
    };

    peerConnection.ontrack = e => {
      attachRemoteStream(e.streams[0]);
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);

    socket.emit('call-user', { to: targetId, offer });
  }

  async function handleIncomingCall(fromId, offer) {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    attachLocalStream(localStream);

    peerConnection = new RTCPeerConnection({ iceServers: ICE_SERVERS });
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        socket.emit('ice-candidate', { to: fromId, candidate: e.candidate });
      }
    };

    peerConnection.ontrack = e => {
      attachRemoteStream(e.streams[0]);
    };

    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('make-answer', { to: fromId, answer });
  }

  function attachLocalStream(stream) {
    let audio = document.getElementById('localAudio');
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'localAudio';
      audio.autoplay = true;
      audio.muted = true;
      document.body.appendChild(audio);
    }
    audio.srcObject = stream;
  }

  function attachRemoteStream(stream) {
    let audio = document.getElementById('remoteAudio');
    if (!audio) {
      audio = document.createElement('audio');
      audio.id = 'remoteAudio';
      audio.autoplay = true;
      document.body.appendChild(audio);
    }
    audio.srcObject = stream;
  }
</script>

<audio id="localAudio" autoplay muted></audio>
<audio id="remoteAudio" autoplay></audio>
{% endif %}
</body>
</html>
