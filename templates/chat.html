<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- SIP.js Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>

</head>
<body>
  {% if session.get('user_id') %}
    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list">
          {% for user in users %}
            <li class="user-item" data-id="{{ user[0] }}">
              <strong>{{ user[1] }}</strong><br>
              <small>{{ user[2] }}</small>
            </li>
          {% endfor %}
        </ul>
      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">âž¤</button>
          <button id="callBtn" disabled>ðŸ“ž Call</button>
          <button id="hangupBtn" disabled>âœ– Hangup</button>
        </div>
      </div>
    </div>

    <script>
  const callBtn   = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  let userAgent, session;

  // Ð¨Ð°Ð³ 1: Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³
  fetch('/sip-config')
    .then(res => {
      if (!res.ok) throw new Error('SIP-config error');
      return res.json();
    })
    .then(cfg => {
      // Ð¨Ð°Ð³ 2: ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ UserAgent
      userAgent = new SIP.UserAgent({
        uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
        transportOptions: {
          server: cfg.wsServers               // Ð¼Ð°ÑÑÐ¸Ð² Ð¸Ð»Ð¸ ÑÑ‚Ñ€Ð¾ÐºÐ° â€” SIP.js ÑÐ°Ð¼ Ñ€Ð°Ð·Ð±ÐµÑ€Ñ‘Ñ‚
        },
        authorizationUsername: cfg.authorizationUser,
        authorizationPassword: cfg.password,
        sessionDescriptionHandlerFactoryOptions: {
          peerConnectionOptions: { iceServers: cfg.iceServers }
        }
      });

      // ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
      userAgent.delegate = {
        onInvite(invitation) {
          session = invitation;
          invitation.accept();
          hangupBtn.disabled = false;
          callBtn.disabled   = true;
          invitation.stateChange.addListener(state => {
            if (state === SIP.SessionState.Terminated) {
              hangupBtn.disabled = true;
              callBtn.disabled   = false;
              session = null;
            }
          });
        }
      };

      userAgent.start()
        .then(() => callBtn.disabled = false)
        .catch(err => console.error('UA start failed:', err));
    })
    .catch(err => console.error(err));

  // Ð˜ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ð¹ Ð·Ð²Ð¾Ð½Ð¾Ðº
  callBtn.onclick = () => {
    const phone = prompt('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ +79991234567):');
    if (!phone || !userAgent) return;
    const target = SIP.UserAgent.makeURI(`sip:${phone}@sip.zadarma.com`);
    session = userAgent.invite(target, {
      sessionDescriptionHandlerOptions: {
        constraints: { audio: true, video: false }
      }
    });
    callBtn.disabled   = true;
    hangupBtn.disabled = false;

    session.stateChange.addListener(state => {
      if (state === SIP.SessionState.Terminated) {
        hangupBtn.disabled = true;
        callBtn.disabled   = false;
        session = null;
      }
    });
  };

  // Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº
  hangupBtn.onclick = () => {
    if (session) session.bye();
  };
</script>
  {% endif %}
</body>
</html>
