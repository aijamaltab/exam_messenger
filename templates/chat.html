<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% if session['user_id'] %}
    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Пользователи</h2>
        <ul id="users" class="user-list"></ul>
      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Выберите пользователя</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <!-- SIP Call Controls -->
          <div class="call-controls">
            <input type="text" id="to-number" placeholder="+7XXXXXXXXXX" style="width: 60%;" />
            <button id="btn-call" style="margin-left: 5px;">Позвонить</button>
            <button id="btn-hangup" disabled style="margin-left: 5px;">Сбросить</button>
          </div>
          <!-- Message Controls -->
          <div class="message-controls" style="margin-top:10px;">
            <input type="text" id="messageInput" placeholder="Введите сообщение">
            <button onclick="sendMessage()">➤</button>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <p>Пожалуйста, <a href="{{ url_for('login') }}">войдите</a> в систему.</p>
  {% endif %}

  <!-- SIP.js и основной скрипт мессенджера -->
  <script src="https://unpkg.com/sip.js@0.20.0/dist/sip.js"></script>
  <script>
    let currentUserId = {{ session['user_id'] }};
    let selectedUserId = null;
    let ua, sessionCall;
    const btnCall = document.getElementById('btn-call');
    const btnHang = document.getElementById('btn-hangup');

    // Получаем конфиг SIP из Flask
    fetch('/sip-config')
      .then(r => r.json())
      .then(cfg => {
        ua = new SIP.UserAgent({
          uri: SIP.UserAgent.makeURI(`sip:${cfg.uri}`),
          authorizationUsername: cfg.authorizationUser,
          authorizationPassword: cfg.password,
          transportOptions: { server: cfg.wsServers },
          delegate: {
            onInvite(invitation) {
              // Входящий звонок: автоматически отвечаем
              invitation.accept().then(() => {
                sessionCall = invitation;
                btnHang.disabled = false;
              });
            }
          },
          iceServers: cfg.iceServers
        });
        ua.start();
        // Привяжем сброс кнопки при завершении сессии
        ua.delegate = { onSessionTerminated: () => btnHang.disabled = true };
      })
      .catch(err => console.error('Ошибка SIP-конфига:', err));

    // Исходящий звонок
    btnCall.onclick = () => {
      const num = document.getElementById('to-number').value.trim();
      if (!num) return alert('Введите номер');
      const targetURI = SIP.UserAgent.makeURI(`sip:${num}@${location.hostname}`);
      const inviter = new SIP.Inviter(ua, targetURI);
      inviter.invite()
        .then(() => {
          sessionCall = inviter;
          btnHang.disabled = false;
        })
        .catch(console.error);
    };

    // Сброс звонка
    btnHang.onclick = () => {
      if (sessionCall) sessionCall.bye();
      btnHang.disabled = true;
    };

    // Загрузка списка пользователей
    fetch('/users')
      .then(response => {
        if (!response.ok) throw new Error('Not authorized');
        return response.json();
      })
      .then(data => {
        const usersUl = document.getElementById("users");
        usersUl.innerHTML = "";
        data.users.forEach(user => {
          const li = document.createElement("li");
          li.innerHTML = `
            <img src="/static/uploads/${user.avatar}" width="30" height="30"
                 style="border-radius:50%; margin-right:10px;">
            <strong>${user.name}</strong><br><small>${user.phone}</small>
          `;
          li.onclick = () => {
            selectedUserId = user.id;
            document.getElementById("chat-with").textContent = "Chat with " + user.name;
            loadMessages(user.id);
          };
          usersUl.appendChild(li);
        });
      })
      .catch(error => {
        console.error('Error loading users:', error);
        alert("Пожалуйста, войдите снова.");
        window.location.href = "/login";
      });

    // Загрузка сообщений
    function loadMessages(userId) {
      fetch(`/messages/${userId}`)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("chat-box");
          container.innerHTML = '';
          data.forEach(msg => {
            const div = document.createElement("div");
            div.className = msg.from_me ? 'message from-me' : 'message from-them';
            div.innerHTML = `
              <p>${msg.message}</p>
              <span class="timestamp">${msg.timestamp}</span>
            `;
            container.appendChild(div);
          });
        })
        .catch(err => console.error("Ошибка при загрузке сообщений:", err));
    }

    // Отправка сообщения
    function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value;
      if (!text || !selectedUserId) return;
      fetch('/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          to_user_id: selectedUserId,
          content: text
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.message === 'OK') {
          loadMessages(selectedUserId);
          input.value = '';
        } else {
          console.error("Ошибка при отправке:", data.error || data.details);
        }
      })
      .catch(err => console.error("Ошибка при fetch:", err));
    }
  </script>
</body>
</html>
