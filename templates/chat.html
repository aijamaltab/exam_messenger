<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- SIP.js библиотека -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>

  <!-- Подключение SIP.js -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.20.0/dist/sip.js"></script>
</head>
<body>
  {% if session['user_id'] %}
    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list"></ul>
      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">➤</button>
          <button id="callBtn" disabled>📞 Call</button>
          <button id="hangupBtn" disabled>✖ Hangup</button>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let selectedUserId = null;
      let userAgent = null;
      let currentSession = null;
    
      // === Инициализация SIP.js ===
      fetch('/sip-config')
        .then(res => res.json())
        .then(cfg => {
          userAgent = new SIP.UserAgent({
            uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
            transportOptions: {
              server: cfg.wsServers
            },
            authorizationUsername: cfg.authorizationUser,
            authorizationPassword: cfg.password,
            sessionDescriptionHandlerOptions: {
              constraints: { audio: true, video: false },
              peerConnectionOptions: {
                iceServers: cfg.iceServers || [{ urls: "stun:stun.l.google.com:19302" }]
              }
            }
          });
    
          userAgent.start();
    
          // При входящем звонке
          userAgent.delegate = {
            onInvite(invitation) {
              currentSession = invitation;
              invitation.accept();
              document.getElementById('hangupBtn').disabled = false;
    
              invitation.stateChange.addListener(state => {
                if (state === SIP.SessionState.Terminated) {
                  currentSession = null;
                  document.getElementById('hangupBtn').disabled = true;
                  document.getElementById('callBtn').disabled = false;
                }
              });
            }
          };
    
          document.getElementById('callBtn').disabled = false;
        })
        .catch(err => {
          console.error("SIP config error:", err);
        });
    
      // === Загрузка списка пользователей ===
      fetch('/users')
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(data => {
          const ul = document.getElementById('users');
          data.users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = `${user.name} (${user.phone})`;
            li.onclick = () => {
              selectedUserId = user.id;
              document.getElementById("chat-with").textContent = "Chat with " + user.name;
              loadMessages(user.id);
              document.querySelectorAll('#users li').forEach(el => el.classList.remove('selected'));
              li.classList.add('selected');
            };
            ul.appendChild(li);
          });
        })
        .catch(() => window.location.href = '/login');
    
      // === Загрузка сообщений ===
      function loadMessages(userId) {
        fetch(`/messages/${userId}`)
          .then(res => res.json())
          .then(messages => {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            messages.forEach(msg => {
              const div = document.createElement('div');
              div.className = msg.from_me ? 'message from-me' : 'message from-them';
              div.innerHTML = `<p>${msg.message}</p><span class="timestamp">${msg.timestamp}</span>`;
              chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
          });
      }
    
      // === Отправка сообщения ===
      function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text || !selectedUserId) return;
    
        fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to_user_id: selectedUserId, message: text })
        })
        .then(res => res.json())
        .then(() => {
          loadMessages(selectedUserId);
          input.value = '';
        });
      }
    
      // === Обработка новых сообщений через сокеты ===
      socket.on('new_message', data => {
        if (data.from_user_id === selectedUserId || data.to_user_id === selectedUserId) {
          loadMessages(selectedUserId);
        }
      });
    
      // === Отправка по Enter ===
      document.getElementById('messageInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });
    
      // === Исходящий звонок ===
      document.getElementById('callBtn').onclick = () => {
        if (!userAgent) return alert("SIP клиент не готов");
    
        const number = prompt('Введите SIP-номер для звонка (например, sip:1001@your-sip-server.com):');
        if (!number) return;
    
        const targetURI = SIP.UserAgent.makeURI(number);
        if (!targetURI) return alert("Неверный SIP URI");
    
        currentSession = userAgent.invite(targetURI, {
          sessionDescriptionHandlerOptions: {
            constraints: { audio: true, video: false }
          }
        });
    
        document.getElementById('callBtn').disabled = true;
        document.getElementById('hangupBtn').disabled = false;
    
        currentSession.stateChange.addListener(state => {
          if (state === SIP.SessionState.Terminated) {
            currentSession = null;
            document.getElementById('callBtn').disabled = false;
            document.getElementById('hangupBtn').disabled = true;
          }
        });
      };
    
      // === Завершение звонка ===
      document.getElementById('hangupBtn').onclick = () => {
        if (currentSession) {
          currentSession.bye();
        }
      };
    </script>
