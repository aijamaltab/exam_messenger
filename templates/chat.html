<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
{% if session.get('user_id') %}
<div class="container">
  <div class="sidebar">
    <form action="{{ url_for('logout') }}" method="GET">
      <button type="submit">Logout</button>
    </form>
    <h2>Users</h2>
    <ul id="users" class="user-list">
      {% for user in users %}
      <li class="user-item" data-id="{{ user[0] }}">
        <strong class="user-name">{{ user[1] }}</strong><br>
        <small>{{ user[2] }}</small>
        <button class="call-user-btn">ðŸ“ž</button>
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="chat">
    <div class="chat-header">
      <h3 id="chat-with">Select a user</h3>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Enter a message" />
      <button id="sendBtn">âž¤</button>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const localUserId = "{{ session['user_id'] }}";
  let selectedUserId = null;

  // On page load, set up user selection
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.user-item').forEach(item => {
      item.addEventListener('click', () => {
        selectedUserId = item.getAttribute('data-id');
        const userName = item.querySelector('.user-name').innerText;
        document.getElementById('chat-with').innerText = `Chat with ${userName}`;
        // Highlight selected
        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        // Clear chat box
        document.getElementById('chat-box').innerHTML = '';
      });
    });

    // Send message on button click
    document.getElementById('sendBtn').addEventListener('click', sendMessage);

    // Receive private message
    socket.on('private_message', ({ from, message }) => {
      // Only show if chat with that user
      if (selectedUserId === from) appendMessage(from, message, false);
    });
  });

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !selectedUserId) return;
    // Emit private message
    socket.emit('private_message', { to: selectedUserId, message: text });
    appendMessage(localUserId, text, true);
    input.value = '';
  }

  function appendMessage(userId, text, isSelf) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = 'chat-message' + (isSelf ? ' self' : '');
    div.innerHTML = `<strong>${isSelf ? 'You' : ''}</strong> ${text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
</script>

{% endif %}
</body>
</html>
