<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
  <!-- Подключение SIP.js -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.20.0/dist/sip.js"></script>
</head>
<body>
  {% if session['user_id'] %}
    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list"></ul>
      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">➤</button>
          <button id="callBtn" disabled>📞 Call</button>
          <button id="hangupBtn" disabled>✖ Hangup</button>
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      let selectedUserId = null;
      let sipUA = null;
      let currentCall = null;

      // Инициализация SIP.js
      fetch('/sip-config')
        .then(r => r.json())
        .then(cfg => {
          sipUA = new SIP.UA({
            uri: cfg.uri,
            transportOptions: { wsServers: cfg.wsServers },
            authorizationUser: cfg.authorizationUser,
            password: cfg.password,
            sessionDescriptionHandlerFactoryOptions: {
              peerConnectionOptions: { iceServers: cfg.iceServers }
            }
          });
          sipUA.on('invite', session => {
            session.accept();
            currentCall = session;
            document.getElementById('hangupBtn').disabled = false;
            session.on('terminated', () => {
              document.getElementById('hangupBtn').disabled = true;
              document.getElementById('callBtn').disabled = false;
              currentCall = null;
            });
          });
          document.getElementById('callBtn').disabled = false;
        })
        .catch(console.error);

      // Загрузка списка пользователей
      fetch('/users')
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          const ul = document.getElementById('users');
          data.users.forEach(u => {
            const li = document.createElement('li');
            li.textContent = u.name + ' (' + u.phone + ')';
            li.onclick = () => { selectedUserId = u.id; loadMessages(u.id); };
            ul.appendChild(li);
          });
        }).catch(() => window.location.href = '/login');

      function loadMessages(userId) {
        fetch(`/messages/${userId}`)
          .then(r => r.json())
          .then(msgs => {
            const box = document.getElementById('chat-box'); box.innerHTML = '';
            msgs.forEach(m => {
              const d = document.createElement('div');
              d.className = m.from_me ? 'message from-me' : 'message from-them';
              d.innerHTML = `<p>${m.message}</p><span class="timestamp">${m.timestamp}</span>`;
              box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
          });
      }

      function sendMessage() {
        const inp = document.getElementById('messageInput');
        if (!inp.value.trim() || !selectedUserId) return;
        fetch('/send', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({to_user_id: selectedUserId, message: inp.value.trim()})
        }).then(r => r.json()).then(() => { loadMessages(selectedUserId); inp.value = ''; });
      }

      socket.on('new_message', d => {
        if (d.from_user_id===selectedUserId||d.to_user_id===selectedUserId) loadMessages(selectedUserId);
      });

      document.getElementById('callBtn').onclick = () => {
        const num = prompt('Enter number to call:'); if (!num) return;
        currentCall = sipUA.invite(num, { sessionDescriptionHandlerOptions:{constraints:{audio:true,video:false}} });
        document.getElementById('hangupBtn').disabled=false;
        currentCall.on('terminated', () => { document.getElementById('hangupBtn').disabled=true; });
      };
      document.getElementById('hangupBtn').onclick = () => { if(currentCall) currentCall.bye(); };

      document.getElementById('messageInput').addEventListener('keypress', e=>{ if(e.key==='Enter'){e.preventDefault();sendMessage();}});
    </script>
