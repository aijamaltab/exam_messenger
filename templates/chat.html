<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>
</head>
<body>
  {% if session.get('user_id') %}

  <div class="container">
    <div class="sidebar">
      <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
        <button type="submit" style="cursor: pointer;">Logout</button>
      </form>
      <h2>Users</h2>
      <ul id="users" class="user-list">
        {% for user in users %}
          <li class="user-item" data-id="{{ user[0] }}">
            <strong>{{ user[1] }}</strong><br />
            <small>{{ user[2] }}</small>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="chat">
      <div class="chat-header">
        <h3 id="chat-with">Select a user</h3>
      </div>

      <div id="chat-box" class="chat-box"></div>

      <div class="chat-controls">
        <input type="text" id="messageInput" placeholder="Enter a message" />
        <button onclick="sendMessage()">âž¤</button>
        <button id="callBtn" disabled>ðŸ“ž Call</button>
        <button id="hangupBtn" disabled>âœ– Hangup</button>
      </div>
    </div>
  </div>

  <script>
    // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    document.querySelectorAll('.user-item').forEach(item => {
      item.addEventListener('click', function () {
        const userId = this.getAttribute('data-id');
        document.getElementById('chat-with').textContent = `Chat with ${this.querySelector('strong').textContent}`;
        fetch(`/messages/${userId}`)
          .then(res => res.json())
          .then(messages => {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            messages.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = 'message';
              msgDiv.textContent = `${msg.sender}: ${msg.text}`;
              chatBox.appendChild(msgDiv);
            });
          });
      });
    });

    function sendMessage() {
      const message = document.getElementById('messageInput').value.trim();
      if (!message) {
        alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ');
        return;
      }
      // Ð ÐµÐ°Ð»Ð¸Ð·ÑƒÐ¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      alert('ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð¿Ð¾ÐºÐ° Ð½Ðµ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð°');
    }

    const callBtn = document.getElementById('callBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    let userAgent, session;
    let cfg = null;

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ SIP-ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð¸ ÑÐ¾Ð·Ð´Ð°Ñ‘Ð¼ UserAgent
    fetch('/sip-config')
      .then(res => {
        if (!res.ok) throw new Error('SIP-config error');
        return res.json();
      })
      .then(config => {
        cfg = config;

        userAgent = new SIP.UserAgent({
          uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
          transportOptions: {
            server: cfg.wsServers // ÑÑ‚Ñ€Ð¾ÐºÐ° Ð¸Ð»Ð¸ Ð¼Ð°ÑÑÐ¸Ð²
          },
          authorizationUsername: cfg.authorizationUser,
          authorizationPassword: cfg.password,
          sessionDescriptionHandlerFactoryOptions: {
            peerConnectionOptions: { iceServers: cfg.iceServers }
          }
        });

        userAgent.delegate = {
          onInvite(invitation) {
            session = invitation;
            invitation.accept();
            hangupBtn.disabled = false;
            callBtn.disabled = true;
            invitation.stateChange.addListener(state => {
              if (state === SIP.SessionState.Terminated) {
                hangupBtn.disabled = true;
                callBtn.disabled = false;
                session = null;
              }
            });
          }
        };

        userAgent.start()
          .then(() => callBtn.disabled = false)
          .catch(err => console.error('UA start failed:', err));
      })
      .catch(err => console.error(err));

    function makeCall(phoneNumber) {
      if (!userAgent || !cfg) return alert("SIP UserAgent Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²");
      const target = SIP.UserAgent.makeURI(`sip:${phoneNumber}@${cfg.domain}`);
      if (!target) return alert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ð´Ð»Ñ Ð·Ð²Ð¾Ð½ÐºÐ°');
      session = userAgent.invite(target, {
        sessionDescriptionHandlerOptions: {
          constraints: { audio: true, video: false }
        }
      });
      hangupBtn.disabled = false;
      callBtn.disabled = true;
      console.log("Calling", phoneNumber);

      session.stateChange.addListener(state => {
        if (state === SIP.SessionState.Terminated) {
          hangupBtn.disabled = true;
          callBtn.disabled = false;
          session = null;
        }
      });
    }

    callBtn.onclick = () => {
      const number = prompt("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 79991234567):");
      if (number) {
        makeCall(number);
      }
    };

    hangupBtn.onclick = () => {
      if (session) {
        session.bye();
      }
    };
  </script>

  {% endif %}
</body>
</html>
