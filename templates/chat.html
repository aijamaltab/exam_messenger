<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>
</head>
<body>
{% if session.get('user_id') %}
<div class="container">
  <div class="sidebar">
    <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
      <button type="submit" style="cursor: pointer;">Logout</button>
    </form>
    <h2>Users</h2>
    <ul id="users" class="user-list">
      {% for user in users %}
        <li class="user-item" data-id="{{ user[0] }}" data-phone="{{ user[2] }}">
          <strong>{{ user[1] }}</strong><br>
          <small>{{ user[2] }}</small>
        </li>
      {% endfor %}
    </ul>
  </div>

  <div class="chat">
    <div class="chat-header">
      <h3 id="chat-with">Select a user</h3>
    </div>

    <div id="chat-box" class="chat-box"></div>

    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Enter a message">
      <button onclick="sendMessage()">âž¤</button>
      <button id="callBtn" disabled>ðŸ“ž Call</button>
      <button id="hangupBtn" disabled>âœ– Hangup</button>
    </div>
  </div>
</div>

<script>
let selectedUserId = null;
let selectedPhone = null;
const callBtn   = document.getElementById('callBtn');
const hangupBtn = document.getElementById('hangupBtn');
let userAgent, session;

// Ð’Ñ‹Ð±Ð¾Ñ€ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
document.querySelectorAll('.user-item').forEach(item => {
  item.addEventListener('click', function () {
    selectedUserId = this.getAttribute('data-id');
    selectedPhone = this.getAttribute('data-phone');

    document.querySelectorAll('.user-item').forEach(el => el.classList.remove('selected'));
    this.classList.add('selected');

    document.getElementById('chat-with').textContent = `Chat with ${this.querySelector('strong').textContent}`;

    // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
    fetch(`/messages/${selectedUserId}`)
      .then(res => res.json())
      .then(messages => {
        const chatBox = document.getElementById('chat-box');
        chatBox.innerHTML = '';
        messages.forEach(msg => {
          const div = document.createElement('div');
          div.className = msg.from_me ? 'my-message' : 'their-message';
          div.textContent = `[${msg.timestamp}] ${msg.message}`;
          chatBox.appendChild(div);
        });
      });
  });
});

// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
function sendMessage() {
  const message = document.getElementById('messageInput').value.trim();
  if (!message || !selectedUserId) {
    alert("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ.");
    return;
  }

  fetch('/send', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ to_user_id: selectedUserId, message: message })
  })
    .then(res => res.json())
    .then(res => {
      if (res.status === 'sent') {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = 'my-message';
        const now = new Date().toLocaleTimeString().slice(0, 5);
        div.textContent = `[${now}] ${message}`;
        chatBox.appendChild(div);
        document.getElementById('messageInput').value = '';
      }
    });
}

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ SIP
fetch('/sip-config')
  .then(res => res.json())
  .then(cfg => {
    userAgent = new SIP.UserAgent({
      uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
      transportOptions: {
        server: cfg.wsServers
      },
      authorizationUsername: cfg.authorizationUser,
      authorizationPassword: cfg.password,
      sessionDescriptionHandlerFactoryOptions: {
        peerConnectionOptions: { iceServers: cfg.iceServers }
      }
    });

    userAgent.delegate = {
      onInvite(invitation) {
        session = invitation;
        invitation.accept();
        hangupBtn.disabled = false;
        callBtn.disabled = true;
        invitation.stateChange.addListener(state => {
          if (state === SIP.SessionState.Terminated) {
            hangupBtn.disabled = true;
            callBtn.disabled = false;
            session = null;
          }
        });
      }
    };

    userAgent.start()
      .then(() => callBtn.disabled = false)
      .catch(err => console.error('SIP UA Error:', err));
  })
  .catch(err => console.error('SIP config error:', err));

// Ð—Ð²Ð¾Ð½Ð¾Ðº
callBtn.onclick = () => {
  if (!selectedPhone || !userAgent) {
    alert("Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ!");
    return;
  }
  const target = SIP.UserAgent.makeURI(`sip:${selectedPhone}@sip.zadarma.com`);
  session = userAgent.invite(target, {
    sessionDescriptionHandlerOptions: {
      constraints: { audio: true, video: false }
    }
  });

  callBtn.disabled = true;
  hangupBtn.disabled = false;

  session.stateChange.addListener(state => {
    if (state === SIP.SessionState.Terminated) {
      hangupBtn.disabled = true;
      callBtn.disabled = false;
      session = null;
    }
  });
};

// Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ð·Ð²Ð¾Ð½ÐºÐ°
hangupBtn.onclick = () => {
  if (session) session.bye();
};
</script>
{% endif %}
</body>
</html>
