<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- SIP.js Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>
</head>
<body>
  {% if session.get('user_id') %}

    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list">
          {% for user in users %}
            <li class="user-item" data-id="{{ user[0] }}" data-phone="{{ user[2] }}" style="cursor:pointer;">
              <strong>{{ user[1] }}</strong><br>
              <small>{{ user[2] }}</small>
              <button class="call-user-btn" style="margin-left:10px;">ðŸ“ž</button>
            </li>
          {% endfor %}
        </ul>
        <script>
          // ÐŸÑ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð½Ð° Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ñ‡Ð°Ñ‚ (ÐºÐ°Ðº Ð±Ñ‹Ð»Ð¾)
          document.querySelectorAll('.user-item').forEach(item => {
            item.addEventListener('click', function(e) {
              // Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸Ðº Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ "call-user-btn", Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡Ð°Ñ‚
              if (e.target.classList.contains('call-user-btn')) return;
              const userId = this.getAttribute('data-id');
              document.getElementById('chat-with').textContent = `Chat with ${this.querySelector('strong').textContent}`;
              fetch(`/messages/${userId}`)
                .then(res => res.json())
                .then(messages => {
                  const chatBox = document.getElementById('chat-box');
                  chatBox.innerHTML = '';
                  messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'message';
                    msgDiv.textContent = `${msg.sender}: ${msg.text}`;
                    chatBox.appendChild(msgDiv);
                  });
                });
            });
          });
        </script>
      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">âž¤</button>
          <button id="callBtn">ðŸ“ž Call</button>
          <button id="hangupBtn" disabled>âœ– Hangup</button>
        </div>
      </div>
    </div>

    <script>
      const callBtn   = document.getElementById('callBtn');
      const hangupBtn = document.getElementById('hangupBtn');
      let userAgent, session, sipConfig;
      
      callBtn.disabled = true;  // Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¸Ð·Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ð¾
      
      fetch('/sip-config')
        .then(res => {
          if (!res.ok) throw new Error('SIP-config error');
          return res.json();
        })
        .then(cfg => {
          sipConfig = cfg;
      
          userAgent = new SIP.UserAgent({
            uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
            transportOptions: {
              server: cfg.wsServers
            },
            authorizationUsername: cfg.authorizationUser,
            authorizationPassword: cfg.password,
            sessionDescriptionHandlerFactoryOptions: {
              peerConnectionOptions: { iceServers: cfg.iceServers }
            }
          });
      
          userAgent.delegate = {
            onInvite(invitation) {
              session = invitation;
              invitation.accept();
              hangupBtn.disabled = false;
              callBtn.disabled   = true;
      
              invitation.stateChange.addListener(state => {
                if (state === SIP.SessionState.Terminated) {
                  hangupBtn.disabled = true;
                  callBtn.disabled   = false;
                  session = null;
                }
              });
            }
          };
      
          return userAgent.start();
        })
        .then(() => {
          callBtn.disabled = false;
          console.log("UserAgent Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð·Ð²Ð¾Ð½ÐºÐ°Ð¼");
        })
        .catch(err => {
          console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° UserAgent:', err);
        });
      
      function makeCall(phoneNumber) {
        if (!userAgent) {
          alert("SIP UserAgent Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²");
          return;
        }
        if (!sipConfig) {
          alert("ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ SIP Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°");
          return;
        }
        const target = SIP.UserAgent.makeURI(`sip:${phoneNumber}@${sipConfig.domain}`);
        if (!target) {
          alert("ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð½Ð¾Ð¼ÐµÑ€Ð°");
          return;
        }
        session = userAgent.invite(target, {
          sessionDescriptionHandlerOptions: {
            constraints: { audio: true, video: false }
          }
        });
      
        hangupBtn.disabled = false;
        callBtn.disabled = true;
      
        session.stateChange.addListener(state => {
          if (state === SIP.SessionState.Terminated) {
            hangupBtn.disabled = true;
            callBtn.disabled = false;
            session = null;
          }
        });
      
        console.log("Ð—Ð²Ð¾Ð½Ð¾Ðº Ð½Ð°", phoneNumber);
      }
      
      callBtn.onclick = () => {
        const number = prompt("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 79991234567):");
        if (number) {
          makeCall(number);
        }
      };
      
      hangupBtn.onclick = () => {
        if (session) session.bye();
      };


      // Ð—Ð²Ð¾Ð½Ð¾Ðº Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ Ð²Ð¾Ð·Ð»Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°
      document.querySelectorAll('.call-user-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°Ð» ÐºÐ»Ð¸Ðº Ð¿Ð¾ li
          const li = btn.closest('.user-item');
          const phone = li.getAttribute('data-phone');
          if (phone) {
            makeCall(phone);
          } else {
            alert("ÐÐ¾Ð¼ÐµÑ€ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½");
          }
        });
      });

      // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (Ñ‚Ð²Ð¾Ð¹ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ¾Ð´)
      function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) return;

        // Ð”Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼ Ñƒ Ñ‚ÐµÐ±Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð° Ñ†ÐµÐ»ÑŒ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸, Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ðº Ñ‚ÐµÐ±Ðµ Ð½ÑƒÐ¶Ð½Ð¾
        // Ð¢ÑƒÑ‚ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€, ÐµÑÐ»Ð¸ Ñƒ Ñ‚ÐµÐ±Ñ ÐµÑÑ‚ÑŒ selectedUserId
        const toUserId = document.querySelector('.user-item.selected')?.getAttribute('data-id');
        if (!toUserId) return alert("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ");

        fetch('/send', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ to_user_id: toUserId, message: text })
        })
        .then(res => res.json())
        .then(res => {
          if (res.status === 'sent') {
            input.value = '';
            // Ð”Ð¾Ð±Ð°Ð²ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ñ‡Ð°Ñ‚, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
          } else {
            alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ');
          }
        });
      }

      // Ð’Ñ‹Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² ÑÐ¿Ð¸ÑÐºÐµ (Ð¿Ñ€Ð¸Ð¼ÐµÑ€)
      document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.user-item').forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
        });
      });

    </script>
  {% endif %}
</body>
</html>
