<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
{% if session.get('user_id') %}
<div class="container">
  <div class="sidebar">
    <form action="{{ url_for('logout') }}" method="GET">
      <button type="submit">Logout</button>
    </form>
    <h2>Users</h2>
    <ul id="users" class="user-list">
      {% for user in users %}
      <li class="user-item" data-id="{{ user[0] }}">
        <strong class="user-name">{{ user[1] }}</strong><br>
        <small>{{ user[2] }}</small>
        <button class="call-user-btn">üìû</button>
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="chat">
    <div class="chat-header">
      <h3 id="chat-with">Select a user</h3>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Enter a message" />
      <button id="sendBtn">‚û§</button>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const localUserId = "{{ session['user_id'] }}";
  let selectedUserId = null;

  // On page load, set up user selection
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.user-item').forEach(item => {
      item.addEventListener('click', () => {
        selectedUserId = item.getAttribute('data-id');
        const userName = item.querySelector('.user-name').innerText;
        document.getElementById('chat-with').innerText = `Chat with ${userName}`;
        // Highlight selected
        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
        // Clear chat box
        document.getElementById('chat-box').innerHTML = '';
      });
    });

    // Send message on button click
    document.getElementById('sendBtn').addEventListener('click', sendMessage);

    // Receive private message
    socket.on('private_message', ({ from, message }) => {
      // Only show if chat with that user
      if (selectedUserId === from) appendMessage(from, message, false);
    });
  });

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text || !selectedUserId) return;
    // Emit private message
    socket.emit('private_message', { to: selectedUserId, message: text });
    appendMessage(localUserId, text, true);
    input.value = '';
  }

  function appendMessage(userId, text, isSelf) {
    const box = document.getElementById('chat-box');
    const div = document.createElement('div');
    div.className = 'chat-message' + (isSelf ? ' self' : '');
    div.innerHTML = `<strong>${isSelf ? 'You' : ''}</strong> ${text}`;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }
  document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', () => {
      selectedUserId = item.dataset.id;
      document.getElementById('chat-with').textContent = 'Chat with ' + item.querySelector('strong').textContent;
      loadMessages(selectedUserId);
    });
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –ë–î
  function loadMessages(userId) {
    fetch(`/messages/${userId}`)
      .then(res => res.json())
      .then(data => {
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        data.forEach(msg => {
          const div = document.createElement('div');
          div.className = msg.from_me ? 'msg msg-me' : 'msg msg-other';
          div.innerHTML = `<span>${msg.message}</span><small>${msg.timestamp}</small>`;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
      });
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message || !selectedUserId) return;

    fetch('/send', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ to_user_id: selectedUserId, message })
    })
    .then(res => res.json())
    .then(() => {
      input.value = '';
    });
  }

  // –ü—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç
  socket.on('new_message', data => {
    const current = selectedUserId;
    const from = String(data.from_user_id);
    const to = String(data.to_user_id);
    const me = "{{ session['user_id'] }}";

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —á–∞—Ç —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    if ((from === current && to === me) || (from === me && to === current)) {
      loadMessages(current);
    }
  });
</script>

{% endif %}
</body>
</html>
