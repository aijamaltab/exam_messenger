<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
{% if session.get('user_id') %}
<div class="container">
  <div class="sidebar">
    <form action="{{ url_for('logout') }}" method="GET">
      <button type="submit">Logout</button>
    </form>
    <h2>Users</h2>
    <ul id="users" class="user-list">
      {% for user in users %}
      <li class="user-item" data-id="{{ user[0] }}">
        <strong>{{ user[1] }}</strong><br>
        <small>{{ user[2] }}</small>
        <button class="call-user-btn">ðŸ“ž</button>
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="chat">
    <div class="chat-header">
      <h3 id="chat-with">Select a user</h3>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-controls">
      <input type="text" id="messageInput" placeholder="Enter a message">
      <button onclick="sendMessage()">âž¤</button>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const ICE_SERVERS = [{ urls: 'stun:stun.l.google.com:19302' }];
  const localUserId = "{{ session['user_id'] }}";
  const peerConnections = new Map();
  const pendingCandidates = {};
  let localStream = null;

  const ringtone = document.getElementById('ringtone');

  socket.on('connect', () => {
    console.log('âœ” Socket connected:', socket.id);
    socket.emit('register', { user_id: localUserId });
  });

  document.addEventListener('DOMContentLoaded', async () => {
    localStream = await getLocalStream();
    attachLocalStream(localStream);

    document.querySelectorAll('.user-item').forEach(item => {
      const btn = item.querySelector('.call-user-btn');
      const targetId = item.dataset.id;
      if (targetId === localUserId) {
        btn.disabled = true;
        return;
      }
      btn.addEventListener('click', () => startCall(targetId));
    });
  });

  async function startCall(to) {
    console.log('â†’ Calling', to);
    const pc = createPeerConnection(to);
    peerConnections.set(to, pc);

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('call-user', { to, offer });
  }

  function createPeerConnection(peerId) {
    const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = event => {
      if (event.candidate) {
        socket.emit('ice-candidate', { to: peerId, candidate: event.candidate });
      }
    };

    pc.ontrack = event => {
      console.log('ðŸ“¡ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑƒÐ´Ð°Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ñ‚Ñ€ÐµÐº:', event.streams[0]);
      attachRemoteStream(event.streams[0]);
    };

    return pc;
  }

  async function getLocalStream() {
    try {
      return await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch (err) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ:', err);
      alert('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½Ñƒ.');
      throw err;
    }
  }

  function attachLocalStream(stream) {
    const audio = document.getElementById('localAudio');
    audio.srcObject = stream;
  }

  function attachRemoteStream(stream) {
    const audio = document.getElementById('remoteAudio');
    audio.srcObject = stream;
    audio.play().catch(e => console.log('ðŸ”‡ ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²ÐµÐ´ÐµÐ½Ð¸Ñ Ð·Ð²ÑƒÐºÐ°:', e));
  }

  socket.on('call-made', async ({ from, offer }) => {
    console.log('â† Incoming call from', from);
    ringtone.play().catch(e => console.log('ðŸ”‡ Ð Ð¸Ð½Ð³Ñ‚Ð¾Ð½ Ð½Ðµ Ð²Ð¾ÑÐ¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ:', e));

    const acceptCall = confirm(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${from} Ð·Ð²Ð¾Ð½Ð¸Ñ‚. ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð²Ñ‹Ð·Ð¾Ð²?`);
    if (!acceptCall) return;

    ringtone.pause();
    ringtone.currentTime = 0;

    const pc = createPeerConnection(from);
    peerConnections.set(from, pc);
    await pc.setRemoteDescription(new RTCSessionDescription(offer));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('make-answer', { to: from, answer });

    if (pendingCandidates[from]) {
      for (const candidate of pendingCandidates[from]) {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      }
      delete pendingCandidates[from];
    }
  });

  socket.on('answer-made', async ({ from, answer }) => {
    console.log('â† Answer from', from);
    const pc = peerConnections.get(from);
    if (pc) {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    }
  });

  socket.on('ice-candidate', async ({ from, candidate }) => {
    const pc = peerConnections.get(from);
    if (pc) {
      await pc.addIceCandidate(new RTCIceCandidate(candidate));
    } else {
      pendingCandidates[from] = pendingCandidates[from] || [];
      pendingCandidates[from].push(candidate);
    }
  });
</script>

<audio id="ringtone" loop>
  <source src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" type="audio/ogg">
</audio>
<audio id="localAudio" autoplay muted></audio>
<audio id="remoteAudio" autoplay></audio>
{% endif %}
</body>
</html>
