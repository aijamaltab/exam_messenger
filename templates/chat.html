<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% if session.get('user_id') %}

  <div class="container">
    <div class="sidebar">
      <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
        <button type="submit" style="cursor: pointer;">Logout</button>
      </form>
      <h2>Users</h2>
      <ul id="users" class="user-list">
        {% for user in users %}
          <li class="user-item" data-id="{{ user[0] }}">
            <strong>{{ user[1] }}</strong><br>
            <small>{{ user[2] }}</small>
          </li>
        {% endfor %}
      </ul>
    </div>

    <div class="chat">
      <div class="chat-header">
        <h3 id="chat-with">Select a user</h3>
      </div>

      <div id="chat-box" class="chat-box"></div>

      <div class="chat-controls">
        <input type="text" id="messageInput" placeholder="Enter a message">
        <button onclick="sendMessage()">‚û§</button>
        <button id="callBtn">üìû Call</button>
      </div>
    </div>
  </div>

  <script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.querySelectorAll('.user-item').forEach(item => {
      item.addEventListener('click', function() {
        const userId = this.getAttribute('data-id');
        document.getElementById('chat-with').textContent = `Chat with ${this.querySelector('strong').textContent}`;
        fetch(`/messages/${userId}`)
          .then(res => res.json())
          .then(messages => {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            messages.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.className = 'message';
              msgDiv.textContent = `${msg.sender}: ${msg.text}`;
              chatBox.appendChild(msgDiv);
            });
          });
      });
    });

    // –ó–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ Twilio
    document.getElementById('callBtn').addEventListener('click', async () => {
      const phone = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, +996XXXXXXXXX):");
      if (!phone) return;

      const formData = new FormData();
      formData.append("phone", phone);

      const res = await fetch("/call", {
        method: "POST",
        body: formData
      });

      const result = await res.json();
      if (result.status === "call_started") {
        alert("–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞–ª—Å—è! SID: " + result.sid);
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ.");
      }
    });

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    function sendMessage() {
      const message = document.getElementById('messageInput').value;
      // –¢—É—Ç –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      alert("–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞");
    }
  </script>

  {% endif %}
</body>
</html>
