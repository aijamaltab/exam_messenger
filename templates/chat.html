<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- SIP.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
</head>
<body>
  {% if session.get('user_id') %}

    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list">
          {% for user in users %}
            <li class="user-item" data-id="{{ user[0] }}" data-phone="{{ user[2] }}" style="cursor:pointer;">
              <strong>{{ user[1] }}</strong><br>
              <small>{{ user[2] }}</small>
              <button class="call-user-btn" style="margin-left:10px;">üìû</button>
            </li>
          {% endfor %}
        </ul>

      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">‚û§</button>
          <button id="callBtn">üìû Call</button>
          <button id="hangupBtn" disabled>‚úñ Hangup</button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (—á–∞—Ç)
        document.querySelectorAll('.user-item').forEach(item => {
          item.addEventListener('click', function(e) {
            if (e.target.classList.contains('call-user-btn')) return;
            const userId = this.getAttribute('data-id');
            document.getElementById('chat-with').textContent = `Chat with ${this.querySelector('strong').textContent}`;
            fetch(`/messages/${userId}`)
              .then(res => res.json())
              .then(messages => {
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML = '';
                messages.forEach(msg => {
                  const msgDiv = document.createElement('div');
                  msgDiv.className = 'message';
                  msgDiv.textContent = `${msg.sender}: ${msg.text}`;
                  chatBox.appendChild(msgDiv);
                });
              });
          });
        });
    
        // SIP.js –∏ –∑–≤–æ–Ω–∫–∏
        const callBtn = document.getElementById('callBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        let userAgent, session, sipConfig;
        
        callBtn.disabled = true;
    
        fetch('/sip-config')
          .then(res => res.json())
          .then(cfg => {
            sipConfig = cfg;
            userAgent = new SIP.UserAgent({
              uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
              transportOptions: { server: cfg.wsServers },
              authorizationUsername: cfg.authorizationUser,
              authorizationPassword: cfg.password,
              sessionDescriptionHandlerFactoryOptions: {
                peerConnectionOptions: { iceServers: cfg.iceServers }
              }
            });
    
            userAgent.delegate = {
              onInvite(invitation) {
                // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
              }
            };
    
            userAgent.start()
              .then(() => callBtn.disabled = false)
              .catch(err => console.error('UA start failed:', err));
          })
          .catch(console.error);
    
        function makeCall(phoneNumber) {
          if (!userAgent) {
            alert("SIP UserAgent –Ω–µ –≥–æ—Ç–æ–≤");
            return;
          }
          if (!sipConfig) {
            alert("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SIP –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
            return;
          }
          const target = SIP.URI.parse(`sip:${phoneNumber}@${sipConfig.domain}`);
          if (!target) {
            alert("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞");
            return;
          }
          session = userAgent.invite(target, {
            sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } }
          });
    
          hangupBtn.disabled = false;
          callBtn.disabled = true;
    
          session.stateChange.addListener(state => {
            if (state === SIP.SessionState.Terminated) {
              hangupBtn.disabled = true;
              callBtn.disabled = false;
              session = null;
            }
          });
    
          console.log("–ó–≤–æ–Ω–æ–∫ –Ω–∞", phoneNumber);
        }
    
        callBtn.onclick = () => {
          const number = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 79991234567):");
          if (number) makeCall(number);
        };
    
        hangupBtn.onclick = () => {
          if (session) session.bye();
        };
    
        document.querySelectorAll('.call-user-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const li = btn.closest('.user-item');
            const phone = li.getAttribute('data-phone');
            if (phone) {
              makeCall(phone);
            } else {
              alert("–ù–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω");
            }
          });
        });
      });
    </script>


  {% endif %}
</body>
</html>
