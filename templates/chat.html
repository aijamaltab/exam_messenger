<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="{{ url_for('static', filename='sip-0.21.2.min.js') }}"></script>



</head>
<body>
  {% if session.get('user_id') %}

    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list">
          {% for user in users %}
            <li class="user-item" data-id="{{ user[0] }}" data-phone="{{ user[2] }}" style="cursor:pointer;">
              <strong>{{ user[1] }}</strong><br>
              <small>{{ user[2] }}</small>
              <button class="call-user-btn" style="margin-left:10px;">📞</button>
            </li>
          {% endfor %}
        </ul>

      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">➤</button>
          <button id="callBtn">📞 Call</button>
          <button id="hangupBtn" disabled>✖ Hangup</button>
        </div>
      </div>
    </div>

   <script>
  document.addEventListener('DOMContentLoaded', () => {
    const callBtn = document.getElementById('callBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    let userAgent, inviter, sipConfig;
  
    callBtn.disabled = true;
  
    fetch('/sip-config')
      .then(res => res.json())
      .then(cfg => {
        sipConfig = cfg;
        const wsServers = cfg.wsServers; // например ["wss://sip.antisip.com:4443/ws"]
  
        userAgent = new SIP.UserAgent({
          uri: SIP.UserAgent.makeURI(`sip:${cfg.authorizationUser}@${cfg.domain}`),
          transportOptions: { server: wsServers },
          authorizationUsername: cfg.authorizationUser,
          authorizationPassword: cfg.password,
          sessionDescriptionHandlerFactoryOptions: {
            peerConnectionOptions: { iceServers: cfg.iceServers }
          }
        });
  
        // входящие
        userAgent.delegate = {
          async onInvite(invitation) {
            inviter = invitation;
            await inviter.accept({
              sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } }
            });
            attachMedia(inviter);
            hangupBtn.disabled = false;
          }
        };
  
        return userAgent.start();
      })
      .then(() => {
        // после старта — регистрируемся на сервере
        return userAgent.register();
      })
      .then(() => {
        console.log("UserAgent started & registered ✔");
        callBtn.disabled = false;
      })
      .catch(err => {
        console.error("SIP init failed:", err);
        alert("Не удалось инициализировать SIP: " + err.message);
      });
  
    function attachMedia(session) {
      const pc = session.sessionDescriptionHandler.peerConnection;
      // remote audio
      pc.addEventListener('track', e => {
        if (e.track.kind === 'audio') {
          document.getElementById('remoteAudio').srcObject = e.streams[0];
        }
      });
      // local audio
      const local = pc.getSenders()
        .filter(s => s.track && s.track.kind === 'audio')
        .map(s => s.track);
      if (local.length) {
        document.getElementById('localAudio').srcObject = new MediaStream(local);
      }
    }
  
    function makeCall(phone) {
      if (!userAgent || userAgent.state !== SIP.UserAgentState.Started) {
        return alert("SIP UserAgent не готов");
      }
      const target = SIP.UserAgent.makeURI(`sip:${phone}@${sipConfig.domain}`);
      if (!target) return alert("Неверный формат номера");
  
      inviter = new SIP.Inviter(userAgent, target, {
        sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } }
      });
  
      inviter.invite()
        .then(() => {
          console.log("Outgoing INVITE sent");
          attachMedia(inviter);
          hangupBtn.disabled = false;
        })
        .catch(err => {
          console.error("Invite failed:", err);
          alert("Ошибка при звонке: " + err.message);
        });
    }
  
    callBtn.addEventListener('click', () => {
      const num = prompt("Введите номер телефона (например, 79991234567):");
      if (num) makeCall(num);
    });
  
    hangupBtn.addEventListener('click', () => {
      if (inviter) inviter.bye();
    });
  });
  </script>

  {% endif %}
</body>
<audio id="remoteAudio" autoplay></audio>
<audio id="localAudio" autoplay muted></audio>


</html>
