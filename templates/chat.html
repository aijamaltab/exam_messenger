<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- SIP.js библиотека -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>

</head>
<body>
  {% if session.get('user_id') %}
    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list">
          {% for user in users %}
            <li class="user-item" data-id="{{ user[0] }}">
              <strong>{{ user[1] }}</strong><br>
              <small>{{ user[2] }}</small>
            </li>
          {% endfor %}
        </ul>
      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">➤</button>
          <button id="callBtn" disabled>📞 Call</button>
          <button id="hangupBtn" disabled>✖ Hangup</button>
        </div>
      </div>
    </div>

    <script>
  const callBtn   = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  let userAgent, session;

  // Шаг 1: получаем конфиг
  fetch('/sip-config')
    .then(res => {
      if (!res.ok) throw new Error('SIP-config error');
      return res.json();
    })
    .then(cfg => {
      // Шаг 2: создаём UserAgent
      userAgent = new SIP.UserAgent({
        uri: `sip:${cfg.authorizationUser}@${cfg.domain}`,
        transportOptions: {
          server: cfg.wsServers               // массив или строка — SIP.js сам разберёт
        },
        authorizationUsername: cfg.authorizationUser,
        authorizationPassword: cfg.password,
        sessionDescriptionHandlerFactoryOptions: {
          peerConnectionOptions: { iceServers: cfg.iceServers }
        }
      });

      // события
      userAgent.delegate = {
        onInvite(invitation) {
          session = invitation;
          invitation.accept();
          hangupBtn.disabled = false;
          callBtn.disabled   = true;
          invitation.stateChange.addListener(state => {
            if (state === SIP.SessionState.Terminated) {
              hangupBtn.disabled = true;
              callBtn.disabled   = false;
              session = null;
            }
          });
        }
      };

      userAgent.start()
        .then(() => callBtn.disabled = false)
        .catch(err => console.error('UA start failed:', err));
    })
    .catch(err => console.error(err));

  // Исходящий звонок
  callBtn.onclick = () => {
    const phone = prompt('Введите телефон (например +79991234567):');
    if (!phone || !userAgent) return;
    const target = SIP.UserAgent.makeURI(`sip:${phone}@sip.zadarma.com`);
    session = userAgent.invite(target, {
      sessionDescriptionHandlerOptions: {
        constraints: { audio: true, video: false }
      }
    });
    callBtn.disabled   = true;
    hangupBtn.disabled = false;

    session.stateChange.addListener(state => {
      if (state === SIP.SessionState.Terminated) {
        hangupBtn.disabled = true;
        callBtn.disabled   = false;
        session = null;
      }
    });
  };

  // Завершить звонок
  hangupBtn.onclick = () => {
    if (session) session.bye();
  };
</script>
  {% endif %}
</body>
</html>
