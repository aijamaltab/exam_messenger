<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="{{ url_for('static', filename='sip-0.21.2.min.js') }}"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>


</head>
<body>
  {% if session.get('user_id') %}

    <div class="container">
      <div class="sidebar">
        <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
          <button type="submit" style="cursor: pointer;">Logout</button>
        </form>
        <h2>Users</h2>
        <ul id="users" class="user-list">
          {% for user in users %}
            <li class="user-item" data-id="{{ user[0] }}" data-phone="{{ user[2] }}" style="cursor:pointer;">
              <strong>{{ user[1] }}</strong><br>
              <small>{{ user[2] }}</small>
              <button class="call-user-btn" style="margin-left:10px;">📞</button>
            </li>
          {% endfor %}
        </ul>

      </div>

      <div class="chat">
        <div class="chat-header">
          <h3 id="chat-with">Select a user</h3>
        </div>

        <div id="chat-box" class="chat-box"></div>

        <div class="chat-controls">
          <input type="text" id="messageInput" placeholder="Enter a message">
          <button onclick="sendMessage()">➤</button>
          <button id="callBtn">📞 Call</button>
          <button id="hangupBtn" disabled>✖ Hangup</button>
        </div>
      </div>
    </div>

   <script>
      const socket = io();  
      socket.on('connect', () => {
        console.log('Подключен к сокетам!');
      });
    document.addEventListener('DOMContentLoaded', () => {
      // === Чат ===
      let currentChatUserId = null;
      const chatWithEl = document.getElementById('chat-with');
      const chatBox = document.getElementById('chat-box');
      const messageInput = document.getElementById('messageInput');
    
      // Выбор пользователя для чата
      document.querySelectorAll('.user-item').forEach(item => {
        item.addEventListener('click', e => {
          if (e.target.classList.contains('call-user-btn')) return;
          currentChatUserId = item.getAttribute('data-id');
          const name = item.querySelector('strong').textContent;
          chatWithEl.textContent = `Chat with ${name}`;
          loadMessages(currentChatUserId);
        });
      });
    
      // Загрузка истории
      function loadMessages(userId) {
        fetch(`/messages/${userId}`)
          .then(res => res.json())
          .then(msgs => {
            chatBox.innerHTML = '';
            msgs.forEach(m => {
              const div = document.createElement('div');
              div.className = m.from_me ? 'message me' : 'message you';
              div.textContent = m.from_me ? `You: ${m.message}` : m.message;
              chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
          });
      }
    
      // Отправка нового сообщения
      window.sendMessage = () => {
        if (!currentChatUserId) return alert('Выберите пользователя слева');
        const text = messageInput.value.trim();
        if (!text) return;
        fetch('/send', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ to_user_id: currentChatUserId, message: text })
        })
        .then(res => res.json())
        .then(() => {
          messageInput.value = '';
          loadMessages(currentChatUserId);
        });
      };
    
      // Обработка входящих через WebSocket
      const socket = io();
      socket.on('new_message', data => {
        if (+data.from_user_id === +currentChatUserId || +data.from_user_id === +sessionStorage.getItem('userId')) {
          loadMessages(currentChatUserId);
        }
      });
    
      // === SIP.js ===
      const callBtn = document.getElementById('callBtn');
      const hangupBtn = document.getElementById('hangupBtn');
      let userAgent, inviter, sipConfig;
    
      callBtn.disabled = true;
    
      fetch('/sip-config')
        .then(res => res.json())
        .then(cfg => {
          sipConfig = cfg;
          userAgent = new SIP.UserAgent({
            uri: SIP.UserAgent.makeURI(cfg.uri),
            displayName: "Jama Tab",
            transportOptions: { server: cfg.wsServers },
            authorizationUsername: cfg.authorizationUser,
            authorizationPassword: cfg.password,
            sessionDescriptionHandlerFactoryOptions: {
              peerConnectionOptions: { iceServers: cfg.iceServers }
            }
          });
      
          userAgent.delegate = {
            async onInvite(inv) {
              inviter = inv;
              await inviter.accept({ sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } } });
              attachMedia(inviter);
              hangupBtn.disabled = false;
            }
          };
      
          return userAgent.start().then(() => userAgent.register());
        })
        .then(() => {
          console.log("SIP started & registered");
          callBtn.disabled = false;
        })
        .catch(err => {
          console.error("SIP init failed:", err);
          alert("SIP error: " + err.message);
        });

    
      function attachMedia(session) {
        const pc = session.sessionDescriptionHandler.peerConnection;
        pc.addEventListener('track', e => {
          if (e.track.kind === 'audio') {
            document.getElementById('remoteAudio').srcObject = e.streams[0];
          }
        });
        const localTracks = pc.getSenders()
          .filter(s => s.track && s.track.kind === 'audio')
          .map(s => s.track);
        if (localTracks.length) {
          document.getElementById('localAudio').srcObject = new MediaStream(localTracks);
        }
      }
    
      function makeCall(phone) {
        if (!userAgent || userAgent.state !== SIP.UserAgentState.Started) {
          return alert('SIP UserAgent не готов');
        }
        const target = SIP.UserAgent.makeURI(`sip:${phone}@${sipConfig.domain}`);
        if (!target) return alert('Неверный формат SIP URI');
    
        inviter = new SIP.Inviter(userAgent, target, {
          sessionDescriptionHandlerOptions:{constraints:{audio:true,video:false}}
        });
    
        inviter.invite()
          .then(() => {
            console.log('Outgoing INVITE sent');
            attachMedia(inviter);
            hangupBtn.disabled = false;
          })
          .catch(e => {
            console.error('Invite failed:', e);
            alert('Ошибка звонка: ' + e.message);
          });
      }
    
      callBtn.addEventListener('click', () => {
        const num = prompt('Введите номер (например, 79991234567):');
        if (num) makeCall(num);
      });
    
      hangupBtn.addEventListener('click', () => {
        if (inviter) inviter.bye();
      });
    
      // Живые кнопки возле пользователя
      document.querySelectorAll('.call-user-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          const phone = btn.closest('.user-item').getAttribute('data-phone');
          if (phone) makeCall(phone);
        });
      });

    </script>

  {% endif %}
  
  <audio id="remoteAudio" autoplay></audio>
  <audio id="localAudio" autoplay muted></audio>
</body>
</html>
