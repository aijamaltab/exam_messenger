<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Messenger Aijamal</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- SIP.js -->
  <script src="https://cdn.jsdelivr.net/npm/sip.js@0.21.2/dist/sip.min.js"></script>
</head>
<body>
  {% if session.get('user_id') %}
  <div class="container">
    <div class="sidebar">
      <form action="{{ url_for('logout') }}" method="GET" style="margin: 0;">
        <button type="submit" style="cursor: pointer;">Logout</button>
      </form>
      <h2>Users</h2>
      <ul id="users" class="user-list">
        {% for user in users %}
        <li class="user-item"
            data-id="{{ user[0] }}"
            data-name="{{ user[1] }}"
            data-phone="{{ user[2] }}">
          <strong>{{ user[1] }}</strong><br>
          <small>{{ user[2] }}</small>
        </li>
        {% endfor %}
      </ul>
    </div>

    <div class="chat">
      <div class="chat-header">
        <h3 id="chat-with">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      </div>

      <div id="chat-box" class="chat-box"></div>

      <div class="chat-controls">
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
        <button id="sendBtn">‚û§</button>
        <button id="callBtn" disabled>üìû Call</button>
        <button id="hangupBtn" disabled>‚úñ Hangup</button>
      </div>
    </div>
  </div>

  <script>
  let selectedUserId = null;
  let selectedUserName = '';
  let selectedUserPhone = '';
  const chatBox = document.getElementById('chat-box');
  const chatWith = document.getElementById('chat-with');
  const sendBtn = document.getElementById('sendBtn');
  const callBtn = document.getElementById('callBtn');
  const hangupBtn = document.getElementById('hangupBtn');
  const messageInput = document.getElementById('messageInput');

  // SIP.js variables
  let userAgent, sipSession, sipConfig;

  // 1) –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞
  document.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', () => {
      selectedUserId    = item.dataset.id;
      selectedUserName  = item.dataset.name;
      selectedUserPhone = item.dataset.phone;
      chatWith.textContent = `Chat with ${selectedUserName}`;
      callBtn.disabled = false;
      loadMessages();
    });
  });

  // 2) –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  function loadMessages() {
    fetch(`/messages/${selectedUserId}`)
      .then(res => res.json())
      .then(msgs => {
        chatBox.innerHTML = '';
        msgs.forEach(m => {
          const div = document.createElement('div');
          div.className = m.from_me ? 'message me' : 'message other';
          div.textContent = m.message;
          chatBox.appendChild(div);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      });
  }

  // 3) –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  sendBtn.onclick = () => {
    const text = messageInput.value.trim();
    if (!selectedUserId || !text) return;
    fetch('/send', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ to_user_id: selectedUserId, message: text })
    })
    .then(res => res.json())
    .then(res => {
      if (res.status === 'sent') {
        messageInput.value = '';
        loadMessages();
      }
    });
  };

  // 4) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SIP.js
  fetch('/sip-config')
    .then(r => r.ok ? r.json() : Promise.reject(r.status))
    .then(cfg => {
      sipConfig = cfg;
      userAgent = new SIP.UserAgent({
        uri: cfg.uri,
        transportOptions: { server: cfg.wsServers },
        authorizationUsername: cfg.authorizationUser,
        authorizationPassword: cfg.password,
        sessionDescriptionHandlerFactoryOptions: {
          peerConnectionOptions: { iceServers: cfg.iceServers }
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
      userAgent.delegate = {
        onInvite(invitation) {
          sipSession = invitation;
          invitation.accept();
          hangupBtn.disabled = false;
          callBtn.disabled = true;
          invitation.stateChange.addListener(state => {
            if (state === SIP.SessionState.Terminated) {
              hangupBtn.disabled = true;
              callBtn.disabled = false;
            }
          });
        }
      };

      return userAgent.start();
    })
    .then(() => {
      console.log('SIP UserAgent started');
    })
    .catch(err => console.error('SIP error:', err));

  // 5) –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∏—Å—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
  callBtn.onclick = () => {
    if (!userAgent || !selectedUserPhone) return;
    const targetURI = SIP.UserAgent.makeURI(`sip:${selectedUserPhone}@${sipConfig.domain}`);
    sipSession = userAgent.invite(targetURI, {
      sessionDescriptionHandlerOptions: { constraints: { audio: true, video: false } }
    });
    sipSession.stateChange.addListener(state => {
      if (state === SIP.SessionState.Established) {
        hangupBtn.disabled = false;
        callBtn.disabled = true;
      }
      if (state === SIP.SessionState.Terminated) {
        hangupBtn.disabled = true;
        callBtn.disabled = false;
      }
    });
  };

  // 6) –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
  hangupBtn.onclick = () => {
    if (sipSession) {
      sipSession.bye();
      sipSession = null;
      hangupBtn.disabled = true;
      callBtn.disabled = false;
    }
  };
  </script>
  {% endif %}
</body>
</html>
